<!doctype html><html lang=vi-vn>
<head>
<link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title> Microservices với NodeJS phần 15 - Managing a NATS Client | Thỉnh thoảng đôi lời</title>
<link rel=canonical href=/posts/backend/microservices-with-node-p15/>
<meta name=description content="Là nơi chia sẻ lại những kiến thức, kinh nghiệm mình tiếp thu được trong quá trình học tập và làm việc. Và thỉnh thoảng cũng đăng một vài demo ngớ ngẩn nữa :smile:">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="all,follow">
<meta name=googlebot content="index,follow,snippet,archive">
<meta property="og:title" content="Microservices với NodeJS phần 15 - Managing a NATS Client">
<meta property="og:description" content="Publishing Ticket Creation Update NATS cho ticket service
npm update @ducnguyen96/ticketing-common // src/events/publishers/ticket-created-publisher.ts export class TicketCreatedPublisher extends Publisher<TicketCreatedEvent> { subject: Subjects.TicketCreated = Subjects.TicketCreated; } Publish event in create.ts when create ticket
// src/routes/create.ts await ticket.save(); await new TicketCreatedPublisher(client).publish({ id: ticket.id, title: ticket.title, price: ticket.price, userId: ticket.userId, }); NATS Client Singleton Cần connect đến NATS trước khi app.listen.
Remember Mongoose ? // src/nats-wrapper.ts import nats, { Stan } from &#34;node-nats-streaming&#34;; class NatsWrapper { private _client?">
<meta property="og:type" content="article">
<meta property="og:url" content="/posts/backend/microservices-with-node-p15/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-09-17T01:00:00+00:00">
<meta property="article:modified_time" content="2021-09-17T01:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Microservices với NodeJS phần 15 - Managing a NATS Client">
<meta name=twitter:description content="Publishing Ticket Creation Update NATS cho ticket service
npm update @ducnguyen96/ticketing-common // src/events/publishers/ticket-created-publisher.ts export class TicketCreatedPublisher extends Publisher<TicketCreatedEvent> { subject: Subjects.TicketCreated = Subjects.TicketCreated; } Publish event in create.ts when create ticket
// src/routes/create.ts await ticket.save(); await new TicketCreatedPublisher(client).publish({ id: ticket.id, title: ticket.title, price: ticket.price, userId: ticket.userId, }); NATS Client Singleton Cần connect đến NATS trước khi app.listen.
Remember Mongoose ? // src/nats-wrapper.ts import nats, { Stan } from &#34;node-nats-streaming&#34;; class NatsWrapper { private _client?">
<link rel=stylesheet href=/css/styles.c05d68261bf086a9d7713c4f8a6215a3601608e267a816a7ee58f139b3d1aae51222aae2081c8e0c6bd35e1334773b7a16283022f31f92afd93bb37e5e822e66.css integrity="sha512-wF1oJhvwhqnXcTxPimIVo2AWCOJnqBan7ljxObPRquUSIqriCByODGvTXhM0dzt6FigwIvMfkq/ZO7N+XoIuZg=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]-->
<link rel=icon type=image/png href=/images/favicon.ico>
</head>
<body class="max-width mx-auto px3 ltr">
<div class="content index py4">
<div id=header-post>
<a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast')" style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu>
<span id=nav>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>Writings</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/tags>Tags</a></li>
<li><a href=/projects/cv>CV</a></li>
</ul>
</span>
<br>
<span id=actions>
<ul>
<li>
<a class=icon href=/posts/backend/microservices-with-node-p14/ aria-label=Previous>
<i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle()" onmouseout="$('#i-prev').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=/posts/backend/microservices-with-node-p16/ aria-label=Next>
<i class="fas fa-chevron-right" aria-hidden=true onmouseover="$('#i-next').toggle()" onmouseout="$('#i-next').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page">
<i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle()" onmouseout="$('#i-top').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=# aria-label=Share>
<i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle()" onmouseout="$('#i-share').toggle()" onclick="return $('#share').toggle(),!1"></i>
</a>
</li>
</ul>
<span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span>
</span>
<br>
<div id=share style=display:none>
<ul>
<li>
<a class=icon href="http://www.facebook.com/sharer.php?u=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f" aria-label=Facebook>
<i class="fab fa-facebook" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://twitter.com/share?url=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&text=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client" aria-label=Twitter>
<i class="fab fa-twitter" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.linkedin.com/shareArticle?url=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&title=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client" aria-label=Linkedin>
<i class="fab fa-linkedin" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&is_video=false&description=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client" aria-label=Pinterest>
<i class="fab fa-pinterest" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="mailto:?subject=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client&body=Check out this article: %2fposts%2fbackend%2fmicroservices-with-node-p15%2f" aria-label=Email>
<i class="fas fa-envelope" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://getpocket.com/save?url=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&title=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client" aria-label=Pocket>
<i class="fab fa-get-pocket" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://reddit.com/submit?url=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&title=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client" aria-label=reddit>
<i class="fab fa-reddit" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.tumblr.com/share/link?url=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&name=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client&description=Publishing%20Ticket%20Creation%20Update%20NATS%20cho%20ticket%20service%0anpm%20update%20%40ducnguyen96%2fticketing-common%20%2f%2f%20src%2fevents%2fpublishers%2fticket-created-publisher.ts%20export%20class%20TicketCreatedPublisher%20extends%20Publisher%26lt%3bTicketCreatedEvent%26gt%3b%20%7b%20subject%3a%20Subjects.TicketCreated%20%3d%20Subjects.TicketCreated%3b%20%7d%20Publish%20event%20in%20create.ts%20when%20create%20ticket%0a%2f%2f%20src%2froutes%2fcreate.ts%20await%20ticket.save%28%29%3b%20await%20new%20TicketCreatedPublisher%28client%29.publish%28%7b%20id%3a%20ticket.id%2c%20title%3a%20ticket.title%2c%20price%3a%20ticket.price%2c%20userId%3a%20ticket.userId%2c%20%7d%29%3b%20NATS%20Client%20Singleton%20C%e1%ba%a7n%20connect%20%c4%91%e1%ba%bfn%20NATS%20tr%c6%b0%e1%bb%9bc%20khi%20app.listen.%0aRemember%20Mongoose%20%3f%20%2f%2f%20src%2fnats-wrapper.ts%20import%20nats%2c%20%7b%20Stan%20%7d%20from%20%26%2334%3bnode-nats-streaming%26%2334%3b%3b%20class%20NatsWrapper%20%7b%20private%20_client%3f" aria-label=Tumblr>
<i class="fab fa-tumblr" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://news.ycombinator.com/submitlink?u=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&t=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client" aria-label="Hacker News">
<i class="fab fa-hacker-news" aria-hidden=true></i>
</a>
</li>
</ul>
</div>
<div id=toc>
<nav id=TableOfContents>
<ul>
<li><a href=#publishing-ticket-creation>Publishing Ticket Creation</a></li>
<li><a href=#nats-client-singleton>NATS Client Singleton</a></li>
<li><a href=#remember-mongoose->Remember Mongoose ?</a></li>
<li><a href=#accessing-the-nats-client>Accessing the NATS client</a></li>
<li><a href=#graceful-shutdown>Graceful Shutdown</a></li>
<li><a href=#ticket-update-publishing>Ticket Update Publishing</a></li>
<li><a href=#failed-event-publishing>Failed Event Publishing</a></li>
<li><a href=#handling-publish-failures>Handling Publish Failures</a></li>
<li><a href=#fixing-a-few-test>Fixing a Few Test</a></li>
<li><a href=#providing-a-mock-implementation>Providing a Mock Implementation</a></li>
<li><a href=#ensuring-mock-invocations>Ensuring Mock Invocations</a></li>
<li><a href=#nats-env-variables>NATS Env Variables</a></li>
</ul>
</nav>
</div>
</span>
</div>
<article class=post itemscope itemtype=http://schema.org/BlogPosting>
<header>
<h1 class=posttitle itemprop="name headline">
Microservices với NodeJS phần 15 - Managing a NATS Client
</h1>
<div class=meta>
<div class=postdate>
<time datetime="2021-09-17 01:00:00 +0000 UTC" itemprop=datePublished>2021-09-17</time>
</div>
<div class=article-category>
<i class="fas fa-archive"></i>
<a class=category-link href=/categories/backend>backend</a>
,
<a class=category-link href=/categories/devops>devops</a>
</div>
<div class=article-tag>
<i class="fas fa-tag"></i>
<a class=tag-link href=/tags/microservices rel=tag>microservices</a>
,
<a class=tag-link href=/tags/nodejs rel=tag>nodejs</a>
,
<a class=tag-link href=/tags/monoliths rel=tag>monoliths</a>
,
<a class=tag-link href=/tags/architecture rel=tag>architecture</a>
,
<a class=tag-link href=/tags/backend rel=tag>backend</a>
,
<a class=tag-link href=/tags/devops rel=tag>devops</a>
</div>
</div>
</header>
<div class=content itemprop=articleBody>
<h2 id=publishing-ticket-creation>Publishing Ticket Creation</h2>
<p>Update NATS cho ticket service</p>
<pre><code class=language-npm data-lang=npm>npm update @ducnguyen96/ticketing-common
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#75715e>// src/events/publishers/ticket-created-publisher.ts
</span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TicketCreatedPublisher</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Publisher</span>&lt;<span style=color:#f92672>TicketCreatedEvent</span>&gt; {
  <span style=color:#a6e22e>subject</span>: <span style=color:#66d9ef>Subjects.TicketCreated</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Subjects</span>.<span style=color:#a6e22e>TicketCreated</span>;
}
</code></pre></div><p>Publish event in <code>create.ts</code> when create ticket</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#75715e>// src/routes/create.ts
</span><span style=color:#75715e></span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>ticket</span>.<span style=color:#a6e22e>save</span>();
<span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TicketCreatedPublisher</span>(<span style=color:#a6e22e>client</span>).<span style=color:#a6e22e>publish</span>({
  <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>ticket.id</span>,
  <span style=color:#a6e22e>title</span>: <span style=color:#66d9ef>ticket.title</span>,
  <span style=color:#a6e22e>price</span>: <span style=color:#66d9ef>ticket.price</span>,
  <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>ticket.userId</span>,
});
</code></pre></div><h2 id=nats-client-singleton>NATS Client Singleton</h2>
<p>Cần connect đến NATS trước khi app.listen.</p>
<p><img src=/images/microservices-dg-185.png alt=microservice-dg-185></p>
<h2 id=remember-mongoose->Remember Mongoose ?</h2>
<p><img src=/images/microservices-dg-186.png alt=microservice-dg-186>
<img src=/images/microservices-dg-187.png alt=microservice-dg-187></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#75715e>// src/nats-wrapper.ts
</span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>nats</span>, { <span style=color:#a6e22e>Stan</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;node-nats-streaming&#34;</span>;

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NatsWrapper</span> {
  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>_client?</span>: <span style=color:#66d9ef>Stan</span>;

  <span style=color:#a6e22e>connect</span>(<span style=color:#a6e22e>clusterId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>clientId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>url</span>: <span style=color:#66d9ef>string</span>) {
    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_client</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>connect</span>(<span style=color:#a6e22e>clusterId</span>, <span style=color:#a6e22e>clientId</span>, { <span style=color:#a6e22e>url</span> });

    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt;((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) <span style=color:#f92672>=&gt;</span> {
      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_client</span><span style=color:#f92672>!</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;connect&#34;</span>, () <span style=color:#f92672>=&gt;</span> {
        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Connected to NATS !&#34;</span>);
        <span style=color:#a6e22e>resolve</span>();
      });

      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_client</span><span style=color:#f92672>!</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;error&#34;</span>, (<span style=color:#a6e22e>err</span>) <span style=color:#f92672>=&gt;</span> {
        <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>err</span>);
      });
    });
  }
}
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>natsWrapper</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>NatsWrapper</span>();
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#75715e>// src/index.ts
</span><span style=color:#75715e></span><span style=color:#66d9ef>try</span> {
  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>natsWrapper</span>.<span style=color:#a6e22e>connect</span>(<span style=color:#e6db74>&#39;ticketing&#39;</span>, <span style=color:#e6db74>&#39;drgdrgd&#39;</span>, <span style=color:#e6db74>&#39;http://nats-srv:4222&#39;</span>)
  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>mongoose</span>...
} <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>error</span>)
}
</code></pre></div><h2 id=accessing-the-nats-client>Accessing the NATS client</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NatsWrapper</span> {
  <span style=color:#66d9ef>get</span> <span style=color:#a6e22e>client() {</span>
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_client</span>) {
      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;Cannot access NATS client before connecting&#34;</span>);
    }

    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_client</span>;
  }
}
</code></pre></div><p>Get client on create ticket route</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TicketCreatedPublisher</span>(<span style=color:#a6e22e>natsWrapper</span>.<span style=color:#a6e22e>client</span>).<span style=color:#a6e22e>publish</span>({
  <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>ticket.id</span>,
  <span style=color:#a6e22e>title</span>: <span style=color:#66d9ef>ticket.title</span>,
  <span style=color:#a6e22e>price</span>: <span style=color:#66d9ef>ticket.price</span>,
  <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>ticket.userId</span>,
});
</code></pre></div><h2 id=graceful-shutdown>Graceful Shutdown</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#75715e>// index.ts
</span><span style=color:#75715e></span><span style=color:#66d9ef>try</span> {
  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>natsWrapper</span>.<span style=color:#a6e22e>connect</span>(<span style=color:#e6db74>&#34;ticketing&#34;</span>, <span style=color:#e6db74>&#34;drgdrgd&#34;</span>, <span style=color:#e6db74>&#34;http://nats-srv:4222&#34;</span>);
  <span style=color:#a6e22e>natsWrapper</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;close&#34;</span>, () <span style=color:#f92672>=&gt;</span> {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;NATS connection closed !&#34;</span>);
    <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>exit</span>();
  });

  <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;SIGINT&#34;</span>, () <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>natsWrapper</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>close</span>());
  <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;SIGTERM&#34;</span>, () <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>natsWrapper</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>close</span>());
} <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>error</span>);
}
</code></pre></div><h2 id=ticket-update-publishing>Ticket Update Publishing</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#75715e>// src/events/publishers/ticket-update-publisher.ts
</span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TicketUpdatedPublisher</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Publisher</span>&lt;<span style=color:#f92672>TicketUpdatedEvent</span>&gt; {
  <span style=color:#a6e22e>subject</span>: <span style=color:#66d9ef>Subjects.TicketUpdated</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Subjects</span>.<span style=color:#a6e22e>TicketUpdated</span>;
}
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#75715e>// src/routes/update.ts
</span><span style=color:#75715e></span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>ticket</span>.<span style=color:#a6e22e>save</span>();
<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TicketUpdatedPublisher</span>(<span style=color:#a6e22e>natsWrapper</span>.<span style=color:#a6e22e>client</span>).<span style=color:#a6e22e>publish</span>({
  <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>ticket.id</span>,
  <span style=color:#a6e22e>title</span>: <span style=color:#66d9ef>ticket.title</span>,
  <span style=color:#a6e22e>price</span>: <span style=color:#66d9ef>ticket.price</span>,
  <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>ticket.userId</span>,
});

<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>ticket</span>);
</code></pre></div><h2 id=failed-event-publishing>Failed Event Publishing</h2>
<p><img src=/images/microservices-dg-188.png alt=microservice-dg-188>
Đối với trường hợp tạo mới ticket ta đã await cho đến khi publishing event hoàn thành rồi mới send ticket về cho user. Lúc này nếu có bất kỳ lỗi nào xảy ra trong 2 await kia thì hệ thống đều bắt được và thông báo lỗi cho user.</p>
<p><img src=/images/microservices-dg-189.png alt=microservice-dg-189>
Còn với update ticket thì ta đã không await, việc này sẽ giúp resquest không bị trễ bị ít do phải chờ publish event, tuy nhiên nếu publishing event lỗi thì hệ thống không bắt được và vẫn trả lại response cho user là mọi việc đều ổn.</p>
<p>Hãy thử tưởng tượng trường hợp trên xảy ra đối với hệ thống rút gửi tiền của ngân hàng.
<img src=/images/microservices-dg-190.png alt=microservice-dg-190>
Ngay sau khi user tạo transaction, transaction service ghi lại transaction vừa rồi nhưng ngay lập tức mất kết nối với NATS và không thể emit được event để accounts service có thể cập nhật được số dư của user.</p>
<p>Vì không await nên ngay sau khi nạp 70, user nhận được thông báo nạp tiền thành công, nhưng vào xem tài khoản thì vẫn chưa được cộng ===> critical issue.</p>
<h2 id=handling-publish-failures>Handling Publish Failures</h2>
<p><img src=/images/microservices-dg-191.png alt=microservice-dg-191>
Để giải quyết vấn đề trên thì ta sẽ lưu lại các events, sau khi lưu thành công event thì sẽ có 1 đoạn code riêng để xử lý và sent events, trường hợp mất kết nối thì đoạn code này sẽ tiếp tục xử lý event này sau khi kết nối lại với nats.</p>
<p>Để đảm bảo là transaction tạo ra nhưng không có event thì ta phải dùng database transation để lưu banking transaction cùng events, nếu 1 trong 2 quá trình save bị lỗi thì phải rollback và báo lỗi đến user.</p>
<h2 id=fixing-a-few-test>Fixing a Few Test</h2>
<p><img src=/images/microservices-dg-192.png alt=microservice-dg-192>
<img src=/images/microservices-dg-193.png alt=microservice-dg-193></p>
<h2 id=providing-a-mock-implementation>Providing a Mock Implementation</h2>
<p><img src=/images/microservices-dg-194.png alt=microservice-dg-194></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#75715e>// src/__mocks__/nats-wrapper.ts
</span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>natsWrapper</span> <span style=color:#f92672>=</span> {};
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#75715e>// src/routes/__test__/create.test.ts
</span><span style=color:#75715e></span><span style=color:#a6e22e>jest</span>.<span style=color:#a6e22e>mock</span>(<span style=color:#e6db74>&#34;../../nats-wrapper&#34;</span>);
</code></pre></div><p><img src=/images/microservices-dg-196.png alt=microservice-dg-196>
<img src=/images/microservices-dg-197.png alt=microservice-dg-197></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#75715e>// src/__mocks__/nats-wrapper.ts
</span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>natsWrapper</span> <span style=color:#f92672>=</span> {
  <span style=color:#a6e22e>client</span><span style=color:#f92672>:</span> {
    <span style=color:#a6e22e>publish</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>subject</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>callback</span><span style=color:#f92672>:</span> () <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>void</span>) <span style=color:#f92672>=&gt;</span> {
      <span style=color:#a6e22e>callback</span>();
    },
  },
};
</code></pre></div><p>Vậy là ta đã thêm được mock cho create event handler, tuy nhiên ta sẽ không thêm <code>jest.mock("../../nats-wrapper")</code> ở mọi nơi mà sẽ chỉ setup 1 lần ở file setup</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#75715e>// src/test/setup.ts
</span><span style=color:#75715e></span><span style=color:#a6e22e>jest</span>.<span style=color:#a6e22e>mock</span>(<span style=color:#e6db74>&#34;../nats-wrapper&#34;</span>);

<span style=color:#a6e22e>beforeEach</span>(<span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
  <span style=color:#a6e22e>jest</span>.<span style=color:#a6e22e>clearAllMocks</span>();
});
</code></pre></div><h2 id=ensuring-mock-invocations>Ensuring Mock Invocations</h2>
<p>Hiện tại thì các test đã pass tuy nhiên chưa có gì chắc chắn là các event đã được publish.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#75715e>// src/__mocks__/nats-wrapper.ts
</span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>natsWrapper</span> <span style=color:#f92672>=</span> {
  <span style=color:#a6e22e>client</span><span style=color:#f92672>:</span> {
    <span style=color:#a6e22e>publish</span>: <span style=color:#66d9ef>jest</span>
      .<span style=color:#a6e22e>fn</span>()
      .<span style=color:#a6e22e>mockImplementation</span>(
        (<span style=color:#a6e22e>subject</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>callback</span><span style=color:#f92672>:</span> () <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>void</span>) <span style=color:#f92672>=&gt;</span> {
          <span style=color:#a6e22e>callback</span>();
        }
      ),
  },
};
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=color:#75715e>// src/routes/__test__/create.test.ts
</span><span style=color:#75715e>// ở 1 test bát kỳ có gọi đến nats ta có thể expect rằng hàm publish của mock implementation đã được gọi
</span><span style=color:#75715e></span><span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>natsWrapper</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>publish</span>).<span style=color:#a6e22e>toHaveBeenCalled</span>();
</code></pre></div><h2 id=nats-env-variables>NATS Env Variables</h2>
<p>Hiện tại thì ta đang kết nối với NATS qua hardcode string, ta sẽ dùng env variables để thay thế</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>containers</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tickets</span>
    <span style=color:#f92672>env</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>NATS_CLIENT_ID</span>
        <span style=color:#f92672>valueFrom</span>:
          <span style=color:#f92672>fieldRef</span>:
            <span style=color:#f92672>fieldPath</span>: <span style=color:#ae81ff>metadata.name</span>
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>NATS_URL</span>
        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;http://nats-srv:4222&#34;</span>
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>NATS_CLUSTER_ID</span>
        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>ticketing</span>
</code></pre></div>
</div>
</article>
<div class=blog-post-comments>
<div id=disqus_thread>
<script type=text/javascript>(function(){var a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,b='ducnguyen96',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
</div>
<div id=footer-post-container>
<div id=footer-post>
<div id=nav-footer style=display:none>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>Writings</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/tags>Tags</a></li>
<li><a href=/projects/cv>CV</a></li>
</ul>
</div>
<div id=toc-footer style=display:none>
<nav id=TableOfContents>
<ul>
<li><a href=#publishing-ticket-creation>Publishing Ticket Creation</a></li>
<li><a href=#nats-client-singleton>NATS Client Singleton</a></li>
<li><a href=#remember-mongoose->Remember Mongoose ?</a></li>
<li><a href=#accessing-the-nats-client>Accessing the NATS client</a></li>
<li><a href=#graceful-shutdown>Graceful Shutdown</a></li>
<li><a href=#ticket-update-publishing>Ticket Update Publishing</a></li>
<li><a href=#failed-event-publishing>Failed Event Publishing</a></li>
<li><a href=#handling-publish-failures>Handling Publish Failures</a></li>
<li><a href=#fixing-a-few-test>Fixing a Few Test</a></li>
<li><a href=#providing-a-mock-implementation>Providing a Mock Implementation</a></li>
<li><a href=#ensuring-mock-invocations>Ensuring Mock Invocations</a></li>
<li><a href=#nats-env-variables>NATS Env Variables</a></li>
</ul>
</nav>
</div>
<div id=share-footer style=display:none>
<ul>
<li>
<a class=icon href="http://www.facebook.com/sharer.php?u=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f" aria-label=Facebook>
<i class="fab fa-facebook fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://twitter.com/share?url=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&text=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client" aria-label=Twitter>
<i class="fab fa-twitter fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.linkedin.com/shareArticle?url=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&title=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client" aria-label=Linkedin>
<i class="fab fa-linkedin fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&is_video=false&description=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client" aria-label=Pinterest>
<i class="fab fa-pinterest fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="mailto:?subject=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client&body=Check out this article: %2fposts%2fbackend%2fmicroservices-with-node-p15%2f" aria-label=Email>
<i class="fas fa-envelope fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://getpocket.com/save?url=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&title=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client" aria-label=Pocket>
<i class="fab fa-get-pocket fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://reddit.com/submit?url=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&title=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client" aria-label=reddit>
<i class="fab fa-reddit fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.tumblr.com/share/link?url=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&name=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client&description=Publishing%20Ticket%20Creation%20Update%20NATS%20cho%20ticket%20service%0anpm%20update%20%40ducnguyen96%2fticketing-common%20%2f%2f%20src%2fevents%2fpublishers%2fticket-created-publisher.ts%20export%20class%20TicketCreatedPublisher%20extends%20Publisher%26lt%3bTicketCreatedEvent%26gt%3b%20%7b%20subject%3a%20Subjects.TicketCreated%20%3d%20Subjects.TicketCreated%3b%20%7d%20Publish%20event%20in%20create.ts%20when%20create%20ticket%0a%2f%2f%20src%2froutes%2fcreate.ts%20await%20ticket.save%28%29%3b%20await%20new%20TicketCreatedPublisher%28client%29.publish%28%7b%20id%3a%20ticket.id%2c%20title%3a%20ticket.title%2c%20price%3a%20ticket.price%2c%20userId%3a%20ticket.userId%2c%20%7d%29%3b%20NATS%20Client%20Singleton%20C%e1%ba%a7n%20connect%20%c4%91%e1%ba%bfn%20NATS%20tr%c6%b0%e1%bb%9bc%20khi%20app.listen.%0aRemember%20Mongoose%20%3f%20%2f%2f%20src%2fnats-wrapper.ts%20import%20nats%2c%20%7b%20Stan%20%7d%20from%20%26%2334%3bnode-nats-streaming%26%2334%3b%3b%20class%20NatsWrapper%20%7b%20private%20_client%3f" aria-label=Tumblr>
<i class="fab fa-tumblr fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://news.ycombinator.com/submitlink?u=%2fposts%2fbackend%2fmicroservices-with-node-p15%2f&t=Microservices%20v%e1%bb%9bi%20NodeJS%20ph%e1%ba%a7n%2015%20-%20Managing%20a%20NATS%20Client" aria-label="Hacker News">
<i class="fab fa-hacker-news fa-lg" aria-hidden=true></i>
</a>
</li>
</ul>
</div>
<div id=actions-footer>
<a id=menu-toggle class=icon href=# onclick="return $('#nav-footer').toggle(),!1" aria-label=Menu>
<i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick="return $('#toc-footer').toggle(),!1" aria-label=TOC>
<i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick="return $('#share-footer').toggle(),!1" aria-label=Share>
<i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page">
<i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a>
</div>
</div>
</div>
<footer id=footer>
<div class=footer-left>
Copyright &copy; 2021 ducnguyen96
</div>
<div class=footer-right>
<nav>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>Writings</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/tags>Tags</a></li>
<li><a href=/projects/cv>CV</a></li>
</ul>
</nav>
</div>
</footer>
</div>
</body>
<link rel=stylesheet href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script>
</html>